<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kits e Materiais</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/tecnico.css">
    <link rel="stylesheet" href="/assets/css/darkMode.css">
    <link rel="icon" href="/images/logo-cps.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>
    <!-- Topo -->
    <ul class="ul-topo">
        <li class="li-topo">
            <div class="campo-preto">
                <a href="https://www.sp.gov.br/sp">
                    <img class="logo-sp" src="/images/logo-sp.png" alt="logo-sp">
                </a>
            </div>
        </li>
        <li class="li-topo">
            <ul class="ul-midias">
                <li class="li-midias"><a href="https://www.instagram.com/governosp/" target="_blank"><img class="img-midias" src="/images/instagram.png" alt=""></a></li>
                <li id="texto-topo-gsp">/governosp</li>
                <li class="controles-acessibilidade">
                    <button id="theme-toggle" onclick="toggleTheme()" class="controles-tamanho" title="Alternar modo claro/escuro"><img src="/images/i-contrast.png" alt=""></button>
                </li>
            </ul>
        </li>
    </ul>

    <hr>

    <!-- Logo e Navegação -->
    <ul class="ul-meio-topo">
        <a href="/pages/index.html">
            <li class="li-meio-topo"><img class="logo-etec" src="/images/logo-etec.png" alt=""></li>
        </a>
    </ul>

    <nav>
        <ul class="nav-bar">
            <li class="li-nav-bar"><a class="a-nav-bar" href="TelaTecnico.html">Home</a></li>
            <li class="li-nav-bar"><a class="a-nav-bar" href="agendamentos_tecnico.html">Agendamentos</a></li>
            <li class="li-nav-bar"><a class="a-nav-bar" href="EstoqueTecnico.html">Estoque</a></li> 
            <li class="li-nav-bar"><a class="a-nav-bar" href="kits_tecnico.html">Kits</a></li> 
        </ul>
    </nav>

    <!-- Conteúdo Principal -->
    <main>
        <h1>Kits</h1>

        <div id="div-search-kit">
            <input type="search" id="search-input" placeholder="Filtrar kits...">
            <button class="clear-search">&times;</button>
            <button class="search-botao"><i class="fa fa-search"></i></button>
        </div>

        <div class="tabela-responsiva-wrapper">
            <table id="tabela-kits-materiais">
                <thead>
                    <tr>
                        <th>Kit</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" style="text-align:center;">Carregando dados...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <footer>
        <a href="https://www.sp.gov.br/sp">
            <img id="img-rodape" src="/images/logo-sp.png" alt="">
        </a>
    </footer>

    <!-- Script de busca -->
    <script>
        const searchInput = document.getElementById('search-input');
        const clearButton = document.querySelector('.clear-search');

        searchInput.addEventListener('input', () => {
            clearButton.style.display = searchInput.value ? 'block' : 'none';
            filtrarTabela();
        });

        clearButton.addEventListener('click', () => {
            searchInput.value = '';
            clearButton.style.display = 'none';
            filtrarTabela();
            searchInput.focus();
        });

        function filtrarTabela() {
            const filtro = searchInput.value.toLowerCase();
            document.querySelectorAll("#tabela-kits-materiais tbody tr").forEach(linha => {
                const texto = linha.textContent.toLowerCase();
                linha.style.display = texto.includes(filtro) ? "" : "none";
            });
        }
    </script>

    <!-- Script principal: carregar dados do MongoDB -->
    <script>
    async function carregarKits() {
        try {
            const response = await fetch("http://localhost:5000/kits");
            const kits = await response.json();

            const tabela = document.querySelector("#tabela-kits-materiais tbody");
            tabela.innerHTML = "";

            kits.forEach(kit => {
                const linha = document.createElement("tr");

                const materiais = kit.materiais.map(m => `${m.item} (${m.quantidade})`).join(", ") || "-";
                const equipamentos = kit.equipamentos.map(e => `${e.item} (${e.quantidade})`).join(", ") || "-";

                linha.innerHTML = `
                    <td>${materiais}</td>
                    <td>${kit.nomeKit}</td>
                    <td>${equipamentos}</td>
                    <td>
                        <button class="btn-editar" onclick="editarKit('${kit._id}')">Editar</button>
                        <button class="btn-excluir" onclick="excluirKit('${kit._id}')">Excluir</button>
                    </td>
                `;
                tabela.appendChild(linha);
            });

        } catch (err) {
            console.error("Erro ao carregar kits:", err);
        }
    }

    async function excluirKit(id) {
        if (!confirm("Tem certeza que deseja excluir este kit?")) return;
        try {
            const resp = await fetch(`http://localhost:5000/kits/${id}`, { method: "DELETE" });
            if (resp.ok) {
                alert("Kit excluído com sucesso!");
                carregarKits();
            } else {
                alert("Erro ao excluir kit.");
            }
        } catch (err) {
            console.error(err);
        }
    }

    carregarKits();
    </script>
</body>
</html>
