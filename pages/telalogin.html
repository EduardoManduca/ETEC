<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tela de Login</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="icon" href="/images/logo-cps.png">
    <script src="/assets/js/script.js"></script>
</head>

<body>

    <ul class="ul-topo">
        <li class="li-topo">
            <div class="campo-preto">
                <a href="https://www.sp.gov.br/sp">
                    <img class="logo-sp" src="/images/logo-sp.png" alt="logo-sp">
                </a>
            </div>
        </li>
        <li class="li-topo">
            <ul class="ul-midias">
                <li class="li-midias"><a href="https://www.flickr.com/photos/governosp/" target="_blank"><img
                            class="img-midias" src="/images/fr.png" alt=""></a></li>
                <li class="li-midias"><a href="https://www.linkedin.com/company/governosp/" target="_blank"><img
                            class="img-midias" src="/images/linkedin.png" alt=""></a></li>
                <li class="li-midias"><a href="https://www.tiktok.com/@governosp" target="_blank"><img
                            class="img-midias" src="/images/tiktok.png" alt=""></a></li>
                <li class="li-midias"><a href="https://www.youtube.com/governosp/" target="_blank"><img
                            class="img-midias" src="/images/youtube.png" alt=""></a></li>
                <li class="li-midias"><a href="https://x.com/governosp/" target="_blank"><img class="img-midias"
                            src="/images/twitter.png" alt=""></a></li>
                <li class="li-midias"><a href="https://www.instagram.com/governosp/" target="_blank"><img
                            class="img-midias" src="/images/instagram.png" alt=""></a></li>
                <li class="li-midias"><a href="https://www.facebook.com/governosp/" target="_blank"><img
                            class="img-midias" src="/images/facebook.png" alt=""></a></li>
                <li id="texto-topo-gsp">/governosp</li>

                <li class="controles-acessibilidade">
                    <button id="aumentar-texto" class="controles-tamanho" title="Aumentar texto"><img
                            src="/images/i-big-font.png" alt=""></button>

                    <button id="diminuir-texto" class="controles-tamanho" title="Diminuir texto"><img
                            src="/images/i-small-font.png" alt=""></button>

                    <button id="theme-toggle" onclick="toggleTheme()" class="controles-tamanho"
                        title="Alternar modo claro/escuro"><img src="/images/i-contrast.png" alt=""></button>

                    <button class="controles-tamanho" title="Mostrar aviso"><img src="/images/i-error-report.png"
                            alt=""></button>
                </li>
            </ul>
        </li>
    </ul>
    <hr>
    <ul class="ul-meio-topo">
        <a href="/pages/telalogin.html">
            <li class="li-meio-topo"><img class="logo-etec" src="/images/logo-etec.png" alt=""></li>
        </a>
    </ul>

    <nav>
        <ul class="nav-bar">
            <li class="li-nav-bar"></li>
            <li class="li-nav-bar"></li>
            <li class="li-nav-bar"></li>
        </ul>
    </nav>
    <main>
        <!-- VLibras Widget -->
        <div vw class="enabled">
            <div vw-access-button class="active"></div>
            <div vw-plugin-wrapper>
                <div class="vw-plugin-top-wrapper"></div>
            </div>
        </div>

        <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
        <script>
            new window.VLibras.Widget('https://vlibras.gov.br/app');
        </script>
        <div id="login">
            <h2 id="titulo-login">Login</h2>
            <p id="paragrafo-login">Por favor, insira seu ID e senha para acessar sua conta.</p>
            <label for="username" class="title-login">ID / Nome:</label>
            <input type="text" id="username" name="username" placeholder="Insira seu ID/Nome" class="cadastro">
            <label for="password" class="title-login">Senha:</label>
            <input type="password" id="password" name="password" placeholder="Insira sua senha" class="cadastro">
            <div id="errorMessage">Nome de usuário ou senha incorretos.</div><br>
            <input type="button" value="Entrar" id="enter" onclick="logincheck()">
            <input type="button" value="Cancelar" id="cancel"
                onclick="window.location.href='/code/Code_Tela_Inicial.html'"> <!--Botão Cancelar-->
        </div>
    </main>
    <footer>
        <a href="https://www.sp.gov.br/sp">
            <img id="img-rodape" src="/images/logo-sp.png" alt="">
        </a>
    </footer>

    <script>
        async function logincheck() {
            const login = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();
            const errorMessage = document.getElementById("errorMessage");

            // Reset do erro antes de tentar login
            errorMessage.style.display = "none";
            errorMessage.textContent = "";

            if (!login || !password) {
                mostrarErro("Login e senha são obrigatórios.");
                return;
            }

            try {
                const resposta = await fetch("http://localhost:5000/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ login, password })
                });

                const resultado = await resposta.json();

                if (resposta.ok) {
                    mostrarSucesso(resultado.message || "✅ Login bem-sucedido!");

                    // Redireciona conforme função
                    const funcao = resultado.usuario.funcao;
                    if (funcao === "admin" || funcao === "administrador") {
                        window.location.href = "/pages/pages_admin/TelaAdministrador.html";
                    } else if (funcao === "professor") {
                        window.location.href = "/pages/pages_professor/TelaProfessor.html";
                    } else if (funcao === "tecnico") {
                        window.location.href = "/pages/pages_tecnico/TelaTecnico.html";
                    } else {
                        window.location.href = "telalogin.html";
                    }
                } else {
                    mostrarErro(resultado.error || "Erro no login.");
                }
            } catch (err) {
                mostrarErro("Erro ao conectar com o servidor.");
                console.error(err);
            }

            // Estilo da mensagem de texto após tentativa de login incorreta
            function mostrarErro(msg) {
                errorMessage.style.display = "block";
                errorMessage.style.color = "#f32a2a";
                errorMessage.textContent = msg;
                errorMessage.classList.add("show");
                setTimeout(() => {
                    errorMessage.classList.remove("show");
                    errorMessage.style.display = "none";
                }, 4000);
            }
            // Estilo da mensagem de texto após tentativa de login correta
            function mostrarSucesso(msg) {
                errorMessage.style.display = "block";
                errorMessage.style.color = "#388E3C";
                errorMessage.textContent = msg;
                errorMessage.classList.add("show");
                setTimeout(() => {
                    errorMessage.classList.remove("show");
                    errorMessage.style.display = "none";
                }, 2000);
            }
        }
    </script>
    </div>
</body>

</html>