<!-- CÓDIGO BASE DO SITE ETEC -->
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico de materiais</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/admin.css">
    <link rel="stylesheet" href="/assets/css/darkMode.css">
    <link rel="icon" href="/assets/images/logo-cps.png">
</head>

<body>

    <ul class="ul-topo">
        <li class="li-topo">
            <div class="campo-preto">
                <a href="https://www.sp.gov.br/sp">
                    <img class="logo-sp" src="/assets/images/logo-sp.png" alt="logo-sp">
                </a>
            </div>
        </li>
        <li class="li-topo">
            <ul class="ul-midias">
                <li class="li-midias"><a href="https://www.flickr.com/photos/governosp/" target="_blank"><img
                            class="img-midias" src="/assets/images/fr.png" alt=""></a></li>
                <li class="li-midias"><a href="https://www.linkedin.com/company/governosp/" target="_blank"><img
                            class="img-midias" src="/assets/images/linkedin.png" alt=""></a></li>
                <li class="li-midias"><a href="https://www.tiktok.com/@governosp" target="_blank"><img
                            class="img-midias" src="/assets/images/tiktok.png" alt=""></a></li>
                <li class="li-midias"><a href="https://www.youtube.com/governosp/" target="_blank"><img
                            class="img-midias" src="/assets/images/youtube.png" alt=""></a></li>
                <li class="li-midias"><a href="https://x.com/governosp/" target="_blank"><img class="img-midias"
                            src="/assets/images/twitter.png" alt=""></a></li>
                <li class="li-midias"><a href="https://www.instagram.com/governosp/" target="_blank"><img
                            class="img-midias" src="/assets/images/instagram.png" alt=""></a></li>
                <li class="li-midias"><a href="https://www.facebook.com/governosp/" target="_blank"><img
                            class="img-midias" src="/assets/images/facebook.png" alt=""></a></li>
                <li id="texto-topo-gsp">/governosp</li>

                <li class="controles-acessibilidade">
                    <button id="aumentar-texto" class="controles-tamanho" title="Aumentar texto"><img
                            src="/assets/images/i-big-font.png" alt=""></button>

                    <button id="diminuir-texto" class="controles-tamanho" title="Diminuir texto"><img
                            src="/assets/images/i-small-font.png" alt=""></button>

                    <button id="theme-toggle" onclick="toggleTheme()" class="controles-tamanho"
                        title="Alternar modo claro/escuro"><img src="/assets/images/i-contrast.png" alt=""></button>

                    <button class="controles-tamanho" title="Mostrar aviso"><a href="https://www.sp.gov.br/sp" target="_blank"><img src="/assets/images/i-error-report.png"
                            alt=""></a></button>
                </li>
            </ul>
        </li>
    </ul>
    <hr>
    <ul class="ul-meio-topo">
        <a href="/pages/index.html">
            <li class="li-meio-topo"><img class="logo-etec" src="/assets/images/logo-etec.png" alt=""></li>
        </a>
    </ul>

    <nav>
        <ul class="nav-bar">
            <li class="li-nav-bar"><a class="a-nav-bar" href="TelaAdministrador.html">Home</a></li>
            <li class="li-nav-bar"><a class="a-nav-bar" href="/pages/pages_admin/HistoricoMateriais.html">Histórico de Materiais</a></li>
            <li class="li-nav-bar"><a class="a-nav-bar" href="/pages/pages_admin/CadastrarUser.html">Cadastro</a></li>
            <li class="li-nav-bar"><a class="a-nav-bar" href="RegistroUsuario.html">Usuarios</a></li>
        </ul>
    </nav>

    <main>
        <h1>Histórico de materiais</h1>

        <!-- Search centralizado -->
        <div id="searchContainer">
            <input type="text" id="searchInput" placeholder="Buscar material, professor ou data">
        </div>

        <!-- Botão apagar histórico -->
        <button class="btn-apagar" id="btnApagar">Apagar Histórico</button>

        <table id="tabelaHistorico">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Professor (a)</th>
                    <th>Materiais</th>
                    <th>Retirada</th>
                </tr>
            </thead>
            <tbody>
                <!-- dados carregados dinamicamente -->
            </tbody>
        </table>
    </main>

    <script>
        const tabela = document.querySelector("#tabelaHistorico tbody");
        const searchInput = document.getElementById("searchInput");

        async function carregarHistorico() {
            try {
                const res = await fetch("http://localhost:5000/estoque");
                const dados = await res.json();

                tabela.innerHTML = "";

                const tipos = ["reagentes", "materiais", "equipamentos"];
                let temItens = false;

                tipos.forEach(tipo => {
                    if (Array.isArray(dados[tipo])) {
                        dados[tipo].forEach(item => {
                            temItens = true;
                            const tr = document.createElement("tr");
                            tr.innerHTML = `
                                <td>${dados.atualizadoEm ? new Date(dados.atualizadoEm).toLocaleDateString("pt-BR") : "-"}</td>
                                <td>${item.professor || "Desconhecido"}</td>
                                <td>${item.nome}</td>
                                <td>${item.quantidade} ${item.unidade || ""}</td>
                            `;
                            tabela.appendChild(tr);
                        });
                    }
                });

                if (!temItens) {
                    tabela.innerHTML = `<tr><td colspan="4" style="text-align:center;">Nenhum item no histórico.</td></tr>`;
                }

            } catch (err) {
                console.error(err);
                tabela.innerHTML = `<tr><td colspan="4" style="text-align:center;">Erro ao carregar histórico.</td></tr>`;
            }
        }

        // Filtrar search
        searchInput.addEventListener("input", () => {
            const termo = searchInput.value.toLowerCase();
            tabela.querySelectorAll("tr").forEach(tr => {
                tr.style.display = tr.textContent.toLowerCase().includes(termo) ? "" : "none";
            });
        });

        // Apagar histórico
        document.getElementById("btnApagar").addEventListener("click", async () => {
            if (!confirm("Tem certeza que deseja apagar todo o histórico de materiais?")) return;

            try {
                const res = await fetch("http://localhost:5000/estoque", { method: "DELETE" });
                const data = await res.json();
                alert(data.message);
                carregarHistorico();
            } catch (err) {
                console.error(err);
                alert("Erro ao apagar histórico.");
            }
        });

        carregarHistorico();
    </script>

    <script src="/assets/js/script.js"></script>

    <script src="/assets/js/ConteudoEstoque.js"></script>
    <button id="btnTopo"></button>
    <script src="/assets/js/ir-ao-topo.js"></script>
    <footer id="footer">
        <a href="https://www.sp.gov.br/sp">
            <img id="img-rodape" src="/assets/images/logo-sp.png" alt="">
        </a>
    </footer>

</body>

</html>